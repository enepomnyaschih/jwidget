<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
	JW ordered collection tests.
	
	Copyright (C) 2013 Egor Nepomnyaschih
	
	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Lesser General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Lesser General Public License for more details.
	
	You should have received a copy of the GNU Lesser General Public License
	along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

JW.Tests.Collection.ObservableSetTestCase = function(config) {
	JW.Tests.Collection.ObservableSetTestCase._super.call(this, config);
	this.a = new JW.Proxy(&quot;a&quot;);
	this.b = new JW.Proxy(&quot;b&quot;);
	this.c = new JW.Proxy(&quot;c&quot;);
	this.d = new JW.Proxy(&quot;d&quot;);
	this.e = new JW.Proxy(&quot;e&quot;);
};

JW.extend(JW.Tests.Collection.ObservableSetTestCase, JW.Unit.TestCase, {
	testObservableSet: function() {
		var set = new JW.ObservableSet();
		this.subscribe(set);
		
		var d = new JW.Proxy(&quot;d&quot;);
		var e = new JW.Proxy(&quot;e&quot;);
		var c = new JW.Proxy(&quot;c&quot;);
		var a = new JW.Proxy(&quot;a&quot;);
		var b = new JW.Proxy(&quot;b&quot;);
		
		this.setExpectedOutput(
			&quot;Spliced -[] +[d]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 0 to 1&quot;
		);
		this.assertTrue(set.add(d));
		this.assertSet([ d ], [ a, b, c, e ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[] +[e]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 1 to 2&quot;
		);
		this.assertTrue(JW.Array.equal([ e ], set.addAll([ e ])));
		this.assertSet([ d, e ], [ a, b, c ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[] +[a,c]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 2 to 4&quot;
		);
		this.assertTrue(JW.Array.equal([ c, a ], set.addAll([ c, a ])));
		this.assertSet([ d, e, c, a ], [ b ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[e] +[]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 4 to 3&quot;
		);
		this.assertTrue(set.remove(e));
		this.assertSet([ d, c, a ], [ b, e ], set);
		
		this.setExpectedOutput();
		this.assertTrue(JW.Array.equal([], set.addAll([])));
		this.assertSet([ d, c, a ], [ b, e ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[] +[b]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 3 to 4&quot;
		);
		this.assertTrue(JW.Array.equal([ b ], set.addAll([ b, c ])));
		this.assertSet([ d, c, a, b ], [ e ], set);
		
		this.setExpectedOutput();
		this.assertTrue(JW.Array.equal([], set.addAll([ b, c ])));
		this.assertSet([ d, c, a, b ], [ e ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[a,d] +[]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 4 to 2&quot;
		);
		this.assertTrue(JW.Array.equal([ a, d ], set.removeAll([ a, d ])));
		this.assertSet([ c, b ], [ a, d, e ], set);
		
		this.setExpectedOutput();
		this.assertTrue(JW.Array.equal([], set.removeAll([ a, d ])));
		this.assertSet([ c, b ], [ a, d, e ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[c] +[a,e]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 2 to 3&quot;
		);
		var spliceResult = set.splice([ d, c ], [ b, a, e ]);
		JW.Tests.Collection.assertSetSpliceResult(this, new JW.AbstractSet.SpliceResult([ c ], [ a, e ]), spliceResult);
		this.assertSet([ b, a, e ], [ c, d ], set);
		
		this.setExpectedOutput();
		spliceResult = set.splice([ d ], [ a ]);
		JW.Tests.Collection.assertSetSpliceResult(this, new JW.AbstractSet.SpliceResult([], []), spliceResult);
		this.assertSet([ b, a, e ], [ c, d ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[b] +[c]&quot;,
			&quot;Changed&quot;
		);
		set.performSplice([ a, c, e ]);
		this.assertSet([ a, c, e ], [ b, d ], set);
		
		// The clearing order differs in Chrome and Firefox:
		// Chrome optimizes integer-based maps and sorts the items, Firefox doesn't.
		// That's why we created items in straight order to make sure that
		// their _iid's will be sorted.
		this.setExpectedOutput(
			&quot;Cleared [a,c,e]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 3 to 0&quot;
		);
		this.assertTrue(new JW.Set(set.clear()).equal([ a, c, e ]));
		this.assertSet([], [ a, b, c, d, e ], set);
		
		this.setExpectedOutput();
		this.assertTrue(JW.Array.equal(set.clear(), []));
		this.assertSet([], [ a, b, c, d, e ], set);
		
		this.setExpectedOutput(
			&quot;Spliced -[] +[a]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 0 to 1&quot;
		);
		this.assertTrue(set.add(a));
		this.assertSet([ a ], [ b, c, d, e ], set);
		
		set.destroy();
	},
	
	testEvery: function() {
		var set = new JW.ObservableSet([ new JW.Proxy(&quot;a&quot;), new JW.Proxy(&quot;A&quot;), new JW.Proxy(&quot;b&quot;) ]);
		
		this.assertFalse(set.every(this.isUpperCase));
		this.assertFalse(set.every(this.isA));
		this.assertTrue (set.every(this.isString));
		this.assertFalse(set.every(this.isNumber));
	},
	
	testSome: function() {
		var set = new JW.ObservableSet([ new JW.Proxy(&quot;a&quot;), new JW.Proxy(&quot;A&quot;), new JW.Proxy(&quot;b&quot;) ]);
		
		this.assertTrue (set.some(this.isUpperCase));
		this.assertTrue (set.some(this.isA));
		this.assertTrue (set.some(this.isString));
		this.assertFalse(set.some(this.isNumber));
	},
	
	testFilter: function() {
		var a = new JW.Proxy(&quot;a&quot;);
		var A = new JW.Proxy(&quot;A&quot;);
		var b = new JW.Proxy(&quot;b&quot;);
		var set = new JW.ObservableSet([ a, A, b ]);
		var filtered = set.$filter(this.isA);
		this.assertTrue(filtered instanceof JW.Set);
		this.assertEqual(3, set.getLength());
		this.assertEqual(2, filtered.getLength());
		this.assertTrue(filtered.contains(a));
		this.assertTrue(filtered.contains(A));
		this.assertFalse(filtered.contains(b));
	},
	
	testMap: function() {
		var a = new JW.Proxy(&quot;a&quot;);
		var b = new JW.Proxy(&quot;b&quot;);
		var c = new JW.Proxy(&quot;c&quot;);
		var results = {
			a: new JW.Proxy(&quot;A&quot;),
			b: new JW.Proxy(&quot;B&quot;),
			c: new JW.Proxy(&quot;C&quot;)
		};
		var set = new JW.ObservableSet([ a, b, c ]);
		var mapped = set.$map(function(x) { return results[x.value]; });
		this.assertTrue(mapped instanceof JW.Set);
		this.assertStrictEqual(3, mapped.getLength());
		this.assertTrue(mapped.contains(results.a));
		this.assertTrue(mapped.contains(results.b));
		this.assertTrue(mapped.contains(results.c));
	},
	
	testRemoveItem: function() {
		var set = new JW.ObservableSet([ this.a, this.b, this.c, this.d ]);
		this.subscribe(set);
		
		this.setExpectedOutput(
			&quot;Spliced -[b] +[]&quot;,
			&quot;Changed&quot;,
			&quot;Changed size from 4 to 3&quot;
		);
		set.removeItem(this.b);
		
		this.setExpectedOutput();
		set.removeItem(this.e);
		
		this.assertTrue(set.equal([ this.a, this.c, this.d ]));
	},
	
	subscribe: function(set) {
		JW.Tests.Collection.subscribeToSet(this, set);
	},
	
	assertSet: function(expected, unexpected, set) {
		JW.Tests.Collection.assertSet(this, expected, unexpected, set);
	},
	
	isUpperCase: function(value) {
		return value.value.toUpperCase() === value.value;
	},
	
	isA: function(value) {
		return value.value.toUpperCase() === &quot;A&quot;;
	},
	
	isString: function(value) {
		return typeof value.value === &quot;string&quot;;
	},
	
	isNumber: function(value) {
		return typeof value.value === &quot;number&quot;;
	}
});

JW.Tests.Collection.ObservableSet = {};
</pre>
</body>
</html>
