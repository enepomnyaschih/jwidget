<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">JW.Audio.Playback = JW.ObservableConfig.extend({
    // Events:
    // finish(event)
    
    track     : null,  // [required] JW.Audio.Track
    autoStart : false, // [optional] Boolean
    
    audioEl   : null,  // [readonly] Audio
    status    : 0,     // [readonly] Integer, 0 - ready, 1 - play, 2 - finished
    
    init: function(config)
    {
        this._super(config);
        
        this.__onEnded = this._onEnded.as(this);
        this.track = JW.Audio.Track.create(this.track);
        
        this.audioEl = new Audio();
        
        var src = this.track.ogg;
        if (!this.audioEl.canPlayType(&quot;audio/ogg&quot;) &amp;&amp; this.audioEl.canPlayType(&quot;audio/mpeg&quot;))
            src = this.track.mp3;
        
        this.audioEl.src = src;
        
        if (this.audioEl.addEventListener)
            this.audioEl.addEventListener('ended', this.__onEnded, false);
        else
            this.audioEl.onended = this.__onEnded;
        
        if (this.autoStart)
            this.__startTimer = setTimeout(this.start.as(this), 1);
    },
    
    destroy: function()
    {
        this.stop();
        
        this._super();
    },
    
    start: function()
    {
        this._abortAutoStart();
        if (!this.isReady())
            return;
        
        this.status = 1;
        this.audioEl.play();
    },
    
    stop: function()
    {
        this._abortAutoStart();
        if (this.isFinished())
            return;
        
        if (this.isPlay())
            this.audioEl.pause();
        
        if (this.audioEl.addEventListener)
            this.audioEl.removeEventListener('ended', this.__onEnded, false);
        else
            delete this.audioEl.onended;
        
        this.status = 2;
        this.audioEl.src = &quot;/dummy&quot;;
        delete this.audioEl;
    },
    
    isReady: function()
    {
        return this.status === 0;
    },
    
    isPlay: function()
    {
        return this.status === 1;
    },
    
    isFinished: function()
    {
        return this.status === 2;
    },
    
    _abortAutoStart: function()
    {
        if (!this.__startTimer)
            return;
        
        clearTimeout(this.__startTimer);
        delete this.__startTimer;
    },
    
    _onEnded: function()
    {
        this.stop();
        this.trigger(&quot;finish&quot;);
    }
});
</pre>
</body>
</html>
