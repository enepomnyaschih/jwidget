<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
	jWidget UI tests.
	
	Copyright (C) 2015 Egor Nepomnyaschih
	
	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Lesser General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Lesser General Public License for more details.
	
	You should have received a copy of the GNU Lesser General Public License
	along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

JW.Tests = {};
JW.Tests.Plugins = {};

JW.Tests.Plugins.RouterTestCase = JW.Unit.TestCase.extend({
	setupAll: function() {
		var test = this;

		test.Base = function(name, path) {
			test.Base._super.call(this);
			this.name = name;
			path = path || null;
			test.output(&quot;Create &quot; + name + &quot; as &quot; + path);
			this.path = this.own(new JW.Property(path));
		};

		JW.extend(test.Base, JW.UI.Component, {
			setPath: function(path) {
				this.path.set(path);
			},

			beforeRender: function() {
				this._super();
				test.output(&quot;Render &quot; + this.name);
			},

			afterDestroy: function() {
				test.output(&quot;Destroy &quot; + this.name);
				this._super();
			}
		});

		test.Routable = function(name, path) {
			test.Routable._super.call(this, name, path);
			this.path.changeEvent.bind(function(params) {
				test.output(&quot;Set &quot; + this.name + &quot; to &quot; + params.value);
			}, this);
		};

		JW.extend(test.Routable, test.Base);

		test.Router = function(name, path, cfg) {
			test.Router._super.call(this, name, path);
			this.cfg = cfg;
		};

		JW.extend(test.Router, test.Base, {
			renderTarget: function() {
				var cfg = JW.apply({}, this.cfg, {path: this.path});
				this.router = this.own(new JW.Plugins.Router(cfg));
				this.router.update();
				return this.router.target;
			}
		});

		JW.UI.template(this.Router, {
			main: '&lt;div style=&quot;display: none;&quot;&gt;&lt;div jwid=&quot;target&quot;&gt;&lt;/div&gt;&lt;/div&gt;'
		});
	},

	testRouter: function() {
		var target = new JW.Property();

		this.setExpectedOutput(
			&quot;Create router as null&quot;,
			&quot;Render router&quot;,
			&quot;Create blank as null&quot;,
			&quot;Render blank&quot;
		);
		var router = new this.Router(&quot;router&quot;, null, {
			handler: {
				routes: {
					&quot;admin&quot;   : function(arg) { return new this.Routable(&quot;admin&quot;, arg);    },
					&quot;app&quot;     : function(arg) { return new this.Routable(&quot;app&quot;, arg);      },
					&quot;settings&quot;: function()    { return new this.Routable(&quot;settings&quot;);      }, // arg is missing by intent - checking setPath call
					&quot;&quot;        : function(arg) { return new this.Routable(&quot;blank&quot;, arg);    }
				},
				notFound: function(route, arg) { return new this.Routable(&quot;not found: &quot; + route, arg); }
			},
			scope: this
		});
		router.renderTo('body');

		this.setExpectedOutput(
			&quot;Destroy blank&quot;,
			&quot;Create admin as null&quot;,
			&quot;Render admin&quot;
		);
		router.path.set(&quot;admin&quot;);

		this.setExpectedOutput();
		router.path.set(&quot;admin&quot;);
		router.path.set(&quot;/admin&quot;);

		this.setExpectedOutput(
			&quot;Set admin to users&quot;
		);
		router.path.set(&quot;admin/users&quot;);

		this.setExpectedOutput(
			&quot;Set admin to companies&quot;
		);
		router.path.set(&quot;admin/companies&quot;);

		this.setExpectedOutput(
			&quot;Destroy admin&quot;,
			&quot;Create app as emails&quot;,
			&quot;Render app&quot;
		);
		router.path.set(&quot;app/emails&quot;);

		this.setExpectedOutput(
			&quot;Set app to null&quot;
		);
		router.path.set(&quot;app&quot;);

		this.setExpectedOutput(
			&quot;Destroy app&quot;,
			&quot;Create blank as null&quot;,
			&quot;Render blank&quot;
		);
		router.path.set(null);

		this.setExpectedOutput();
		router.path.set(&quot;&quot;);

		this.setExpectedOutput(
			&quot;Destroy blank&quot;,
			&quot;Create settings as null&quot;,
			&quot;Render settings&quot;,
			&quot;Set settings to profile/password&quot;
		);
		router.path.set(&quot;settings/profile/password&quot;);

		this.setExpectedOutput(
			&quot;Destroy settings&quot;,
			&quot;Create not found: other as smile/happy&quot;,
			&quot;Render not found: other&quot;
		);
		router.path.set(&quot;other/smile/happy&quot;);

		this.setExpectedOutput(
			&quot;Destroy not found: other&quot;,
			&quot;Destroy router&quot;
		);
		router.destroy();
	},

	testSubrouter: function() {
		var target = new JW.Property();

		this.setExpectedOutput(
			&quot;Create router as null&quot;,
			&quot;Render router&quot;,
			&quot;Create blank as null&quot;,
			&quot;Render blank&quot;
		);
		var router = new this.Router(&quot;router&quot;, null, {
			handler: {
				routes: {
					&quot;admin&quot;: function(arg) {
						return new this.Router(&quot;admin&quot;, arg, {
							handler: {
								routes: {
									&quot;users&quot; : function(arg) { return new this.Routable(&quot;users&quot;, arg);  },
									&quot;&quot;      : function(arg) { return new this.Routable(&quot;a-blank&quot;, arg) }
								}
							},
							scope: this
						});
					},
					&quot;settings&quot;: function(arg) {
						return new this.Router(&quot;settings&quot;, arg, {
							handler: {
								routes: {
									&quot;profile&quot;: function(arg) { return new this.Routable(&quot;profile&quot;, arg); },
									&quot;social&quot; : function(arg) { return new this.Routable(&quot;social&quot;, arg);  },
									&quot;&quot;       : function(arg) { return new this.Routable(&quot;s-blank&quot;, arg)  }
								}
							},
							scope: this
						});
					},
					&quot;&quot;: function(arg) { return new this.Routable(&quot;blank&quot;, arg); }
				},
				notFound: function(route, arg) { return new this.Routable(&quot;not found: &quot; + route, arg); }
			},
			scope: this
		});
		router.renderTo('body');

		this.setExpectedOutput(
			&quot;Destroy blank&quot;,
			&quot;Create admin as null&quot;,
			&quot;Render admin&quot;,
			&quot;Create a-blank as null&quot;,
			&quot;Render a-blank&quot;
		);
		router.path.set(&quot;admin&quot;);

		this.setExpectedOutput(
			&quot;Destroy a-blank&quot;,
			&quot;Create users as null&quot;,
			&quot;Render users&quot;
		);
		router.path.set(&quot;admin/users&quot;);

		this.setExpectedOutput(
			&quot;Destroy users&quot;,
			&quot;Destroy admin&quot;,
			&quot;Create settings as profile&quot;,
			&quot;Render settings&quot;,
			&quot;Create profile as null&quot;,
			&quot;Render profile&quot;
		);
		router.path.set(&quot;settings/profile&quot;);

		this.setExpectedOutput(
			&quot;Set profile to companies&quot;
		);
		router.path.set(&quot;settings/profile/companies&quot;);

		this.setExpectedOutput(
			&quot;Destroy profile&quot;,
			&quot;Create social as facebook&quot;,
			&quot;Render social&quot;
		);
		router.path.set(&quot;settings/social/facebook&quot;);

		this.setExpectedOutput(
			&quot;Destroy social&quot;,
			&quot;Destroy settings&quot;,
			&quot;Destroy router&quot;
		);
		router.destroy();
	},

	testDestroyActiveError: function() {
		this.setExpectedOutput(
			&quot;Create router as one&quot;,
			&quot;Render router&quot;
		);
		var router = new this.Router(&quot;router&quot;, &quot;one&quot;, {
			handler: {
				routes: {
					&quot;one&quot;: function(arg) {
						router.path.set(&quot;two&quot;);
					}
				}
			},
			scope: this
		});

		try {
			router.renderTo(&quot;body&quot;);
		} catch (e) {
			if (e.message.indexOf(&quot;Can't update router because its update cycle is already active&quot;) === 0) {
				JW.Plugins.Router._routerStack = [];
				return;
			}
		}
		JW.Plugins.Router._routerStack = [];
		throw new Error(&quot;Active router error wasn't thrown&quot;);
	},

	testDestroyNonTopError: function() {
		this.setExpectedOutput(
			&quot;Create router as one&quot;,
			&quot;Render router&quot;
		);
		var router = new this.Router(&quot;router&quot;, &quot;one&quot;, {
			handler: {
				routes: {}
			},
			scope: this
		});
		router.renderTo(&quot;body&quot;);

		this.setExpectedOutput(
			&quot;Create router2 as two&quot;,
			&quot;Render router2&quot;
		);
		var router2 = new this.Router(&quot;router2&quot;, &quot;two&quot;, {
			handler: {
				routes: {}
			},
			scope: this
		});
		router2.renderTo(&quot;body&quot;);

		try {
			router.router.destroy();
		} catch (e) {
			if (e.message.indexOf(&quot;Router can not be destroyed because it is not on top of router stack&quot;) === 0) {
				JW.Plugins.Router._routerStack = [];
				return;
			}
		}
		JW.Plugins.Router._routerStack = [];
		throw new Error(&quot;Router stack position error wasn't thrown&quot;);
	},

	testRedirect: function() {
		var target = new JW.Property();

		this.setExpectedOutput(
			&quot;Create router as null&quot;,
			&quot;Render router&quot;
		);
		var router = new this.Router(&quot;router&quot;, null, {
			handler: {
				routes: {
					&quot;source&quot;: function(arg) { return new JW.Plugins.Router.Redirector(&quot;target/&quot; + arg); },
					&quot;target&quot;: function(arg) {
						return new this.Router(&quot;target&quot;, arg, {
							handler: {
								routes: {
									&quot;source&quot;: function(arg) { return new JW.Plugins.Router.Redirector(&quot;target/&quot; + arg); },
									&quot;target&quot;: function(arg) { return new this.Routable(&quot;nested-target&quot;, arg); },
									&quot;back&quot;  : function(arg) { return new JW.Plugins.Router.Redirector(&quot;target2&quot;, -1); },
									&quot;abs&quot;   : function(arg) { return new JW.Plugins.Router.Redirector(&quot;target2&quot;, 0); },
									&quot;into&quot;  : function(arg) { return new JW.Plugins.Router.Redirector(&quot;source/jaja&quot;, 1); }
								}
							},
							scope: this
						});
					},
					&quot;target2&quot;: function(arg) {
						return new this.Router(&quot;target2&quot;, arg, {
							handler: {
								routes: {
								}
							},
							scope: this
						});
					},
					&quot;admin&quot;: function(arg) { return new this.Routable(&quot;admin&quot;, arg); }
				}
			},
			scope: this
		});
		router.renderTo(&quot;body&quot;);

		step0.call(this);

		function step0() {
			this.setExpectedOutput(
				&quot;Create target as hello&quot;,
				&quot;Render target&quot;
			);
			router.path.set(&quot;source/hello&quot;);

			this.sleep(100, step1, this);
		}

		function step1() {
			this.assertStrictEqual(&quot;target/hello&quot;, router.path.get());

			this.setExpectedOutput(
				&quot;Create nested-target as magic&quot;,
				&quot;Render nested-target&quot;
			);
			router.path.set(&quot;target/source/magic&quot;);

			this.sleep(100, step2, this);
		}

		function step2() {
			this.assertStrictEqual(&quot;target/target/magic&quot;, router.path.get());

			this.setExpectedOutput(
				&quot;Destroy nested-target&quot;,
				&quot;Destroy target&quot;,
				&quot;Create target2 as null&quot;,
				&quot;Render target2&quot;
			);
			router.path.set(&quot;target/back&quot;);

			this.sleep(100, step3, this);
		}

		function step3() {
			this.assertStrictEqual(&quot;target2&quot;, router.path.get());

			this.setExpectedOutput(
				&quot;Destroy target2&quot;,
				&quot;Create target as target&quot;,
				&quot;Render target&quot;,
				&quot;Create nested-target as null&quot;,
				&quot;Render nested-target&quot;
			);
			router.path.set(&quot;target/target&quot;);

			this.setExpectedOutput(
				&quot;Destroy nested-target&quot;,
				&quot;Destroy target&quot;,
				&quot;Create target2 as null&quot;,
				&quot;Render target2&quot;
			);
			JW.Plugins.Router.redirect(&quot;abs&quot;);

			this.sleep(100, step4, this);
		}

		function step4() {
			this.assertStrictEqual(&quot;target2&quot;, router.path.get());

			this.setExpectedOutput(
				&quot;Destroy target2&quot;,
				&quot;Create target as target&quot;,
				&quot;Render target&quot;,
				&quot;Create nested-target as null&quot;,
				&quot;Render nested-target&quot;
			);
			router.path.set(&quot;target/target&quot;);

			this.setExpectedOutput(
				&quot;Destroy nested-target&quot;, // redirecting to source
				&quot;Create nested-target as jaja&quot;, // and back to target
				&quot;Render nested-target&quot;
			);
			JW.Plugins.Router.redirect(&quot;target/into&quot;, -1);

			this.sleep(100, step5, this);
		}

		function step5() {
			this.assertStrictEqual(&quot;target/target/jaja&quot;, router.path.get());

			this.setExpectedOutput(
				&quot;Destroy nested-target&quot;,
				&quot;Destroy target&quot;,
				&quot;Create admin as vasya&quot;,
				&quot;Render admin&quot;
			);
			router.router.redirect(&quot;admin/vasya&quot;);

			this.setExpectedOutput(
				&quot;Destroy admin&quot;,
				&quot;Destroy router&quot;
			);
			router.destroy();
		}
	},

	testRedirectNoRouterError: function() {
		try {
			JW.Plugins.Router.redirect(&quot;hello&quot;);
		} catch (e) {
			if (e.message.indexOf(&quot;Can not perform URL redirection to hello in scope CURRENT: No routers exist in the system.&quot;) === 0) {
				return;
			}
		}
		JW.Plugins.Router._routerStack = [];
		throw new Error(&quot;Router inexistance error wasn't thrown&quot;);
	},

	testRedirectActiveError: function() {
		this.setExpectedOutput(
			&quot;Create router as one&quot;,
			&quot;Render router&quot;
		);
		var router = new this.Router(&quot;router&quot;, &quot;one&quot;, {
			handler: {
				routes: {
					&quot;one&quot;: function(arg) {
						JW.Plugins.Router.redirect(&quot;hello&quot;);
					}
				}
			},
			scope: this
		});

		try {
			router.renderTo(&quot;body&quot;);
		} catch (e) {
			if (e.message.indexOf(&quot;Can not perform URL redirection to hello in scope CURRENT: Update cycle is already active.&quot;) === 0) {
				JW.Plugins.Router._routerStack = [];
				return;
			}
		}
		JW.Plugins.Router._routerStack = [];
		throw new Error(&quot;Active router error wasn't thrown&quot;);
	},

	testRedirectDepthError: function() {
		this.setExpectedOutput(
			&quot;Create router as one&quot;,
			&quot;Render router&quot;
		);
		var router = new this.Router(&quot;router&quot;, &quot;one&quot;, {
			handler: {
				routes: {}
			},
			scope: this
		});
		router.renderTo(&quot;body&quot;);

		try {
			JW.Plugins.Router.redirect(&quot;hello&quot;, -1)
		} catch (e) {
			if (e.message.indexOf(&quot;Can not perform URL redirection to hello in scope -1: Current router stack contains only&quot;) === 0) {
				JW.Plugins.Router._routerStack = [];
				return;
			}
		}
		JW.Plugins.Router._routerStack = [];
		throw new Error(&quot;Router stack depth error wasn't thrown&quot;);
	}
});

jQuery(function() {
	setTimeout(function() {
		JW.Unit.run(&quot;JW.Tests&quot;, JW.Tests);
	}, 1000);
});
</pre>
</body>
</html>
