/*!
	jWidget Router plugin

	http://enepomnyaschih.github.io/jwidget/#!/api/JW.Plugins.Router

	Copyright (C) 2015 Egor Nepomnyaschih

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Lesser General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Lesser General Public License for more details.

	You should have received a copy of the GNU Lesser General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
JW.Plugins=JW.Plugins||{};JW.Plugins.Router=function(a){JW.Plugins.Router._super.call(this);a=a||{};this.separator=a.separator||"/";if(typeof this.separator==="string"){this.separator=JW.Plugins.Router.makeSeparator(this.separator)}this.handler=a.handler||{};if(typeof this.handler==="object"){this.handler=JW.Plugins.Router.makeHandler(this.handler)}this.scope=a.scope||this;this._pathCreated=a.path==null;this.path=this._pathCreated?new JW.Property():a.path;this._targetCreated=a.target==null;this.target=this._targetCreated?new JW.Property():a.target;this.route=new JW.Property();this.own(new JW.Switcher([this.route],{init:function(b){this.target.set(this.handler.call(this.scope,b)||null)},done:function(b){var c=this.target.get();this.target.set(null);if(c!=null){c.destroy()}},scope:this}));this.update();this.own(this.path.changeEvent.bind(this.update,this))};JW.extend(JW.Plugins.Router,JW.Class,{destroyObject:function(){if(this._targetCreated){this.target.destroy()}if(this._pathCreated){this.path.destroy()}this.route.destroy();this.separator=null;this.handler=null;this.scope=null;this.path=null;this.target=null;this.route=null;this._super()},update:function(){var d=this.path.get();var e=(d==null)?null:this.separator.call(this.scope,d);var b=e;var a=null;if(e!=null&&(typeof e!=="string")){b=e[0];a=e[1]}this.route.set(b||"");var c=this.target.get();if(c!=null&&(typeof c.setPath==="function")){c.setPath(a)}}});JW.Plugins.Router.makeSeparator=function(b){var a=new RegExp("^(?:"+b.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")+")*");return function(d){d=d.replace(a,"");var c=d.indexOf(b);if(c===-1){return d}return[d.substr(0,c),d.substr(c+b.length)]}};JW.Plugins.Router.makeHandler=function(a){return function(b){var c=a.routes[b]||a.notFound;return c?c.call(this,b):null}};