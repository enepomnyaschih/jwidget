/*!
	jWidget Router plugin

	http://enepomnyaschih.github.io/jwidget/#!/api/JW.Plugins.Router

	Copyright (C) 2015 Egor Nepomnyaschih

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Lesser General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Lesser General Public License for more details.

	You should have received a copy of the GNU Lesser General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
JW.Plugins=JW.Plugins||{};JW.Plugins.Router=function(a){JW.Plugins.Router._super.call(this);a=a||{};this.separator=a.separator||this.defaultSeparator;if(JW.isRegExp(this.separator)){this.separator=JW.Plugins.Router.makeSeparator(this.separator)}this.joiner=a.joiner||this.defaultJoiner;if(typeof this.joiner==="string"){this.joiner=JW.Plugins.Router.makeJoiner(this.joiner)}this.handler=a.handler||{};if(typeof this.handler==="object"){this.handler=JW.Plugins.Router.makeHandler(this.handler)}this.scope=a.scope||this;this._pathCreated=a.path==null;this.path=this._pathCreated?new JW.Property():a.path;this._targetCreated=a.target==null;this.target=this._targetCreated?new JW.Property():a.target;this.route=new JW.Property();this.own(new JW.Switcher([this.route],{init:function(b){this.target.set(this.handler.call(this.scope,b,this.arg)||null)},done:function(b){var c=this.target.get();this.target.set(null);if(c!=null){c.destroy()}},scope:this}));this.arg=null;JW.Plugins.Router._routerStack.push(this);this._active=false;this.own(this.path.changeEvent.bind(this.update,this))};JW.extend(JW.Plugins.Router,JW.Class,{defaultSeparator:/^\/*([^?\/]+)(?:\/(.*)|(\?.*))?$/,defaultJoiner:"/",destroyObject:function(){if(this._active){throw new Error("Router can not be destroyed during its update cycle.")}if(JW.Array.getLast(JW.Plugins.Router._routerStack)!==this){throw new Error("Router can not be destroyed because it is not on top of router stack. Make sure that you don't create two subrouters in parallel. Make sure that you destroy all routers correctly.")}JW.Plugins.Router._routerStack.pop();if(this._targetCreated){this.target.destroy()}if(this._pathCreated){this.path.destroy()}this.route.destroy();this.separator=null;this.handler=null;this.scope=null;this.path=null;this.target=null;this.route=null;this._super()},update:function(){if(this._active){throw new Error("Can't update router because its update cycle is already active. Suggest using JW.Plugins.Router.Redirector or moving URL redirection to an asyncronous callback.")}this._active=true;var c=this.path.get();var d=(c==null)?null:this.separator.call(this.scope,c);var a=d;this.arg=null;if(d!=null&&(typeof d!=="string")){a=d[0];if(d.length>1){this.arg=d[1]}}this.route.set(a||"");var b=this.target.get();if(b!=null&&(typeof b.setPath==="function")){b.setPath(this.arg)}this._active=false},join:function(b,a){return this.joiner.call(this.scope,b,a)},getFullPath:function(b,a){return JW.Plugins.Router.getFullPath(b,this,a)},redirect:function(c,b,a){JW.Plugins.Router.redirect(c,this,b,a)}});JW.apply(JW.Plugins.Router,{_routerStack:[],getFullPath:function(g,c,f){if(typeof c==="number"){f=c;c=null}var a=JW.Plugins.Router._routerStack;if(a.length==0){throw new Error("No routers exist in the system.")}var b=c?JW.Array.indexOf(a,c):(a.length-1);if(b===-1){throw new Error("Current router stack doesn't contain the specified router.")}var d=(f==null)?b:(f>=0)?f:(b+f);if(d<0||d>b){throw new Error(c?("The specified router has index "+b+" in current router stack"):("Current router stack contains only "+a.length+" routers."))}for(var e=d-1;e>=0;--e){g=a[e].join(a[e].route.get(),g)}return g},redirect:function(g,b,d,a){if(typeof b==="number"){d=b;b=null}var c;try{c=JW.Plugins.Router.getFullPath(g,b,d);if(JW.Plugins.Router._routerStack[0]._active){throw new Error("Update cycle is already active. Suggest using JW.Plugins.Router.Redirector or moving URL redirection to an asyncronous callback.")}}catch(f){throw new Error("Can not perform URL redirection to "+g+" in scope "+((d==null)?"CURRENT":d)+": "+f.message)}JW.Plugins.Router._routerStack[0].path.set(c,a)},makeSeparator:function(a){return function(c){var b=a.exec(c||"");return b?[b[1],JW.def(JW.Array.search(b.slice(2),JW.isSet),null)]:""}},makeJoiner:function(a){var b=new RegExp("^(?:"+a.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")+")*");return function(d,c){return !c?d:(c.charAt(0)==="?")?(d+c):(d+a+c.replace(b,""))}},makeHandler:function(b){b=b||{};var a=b.routes||{};return function(d,c){return a[d]?a[d].call(this,c):b.notFound?b.notFound.call(this,d,c):null}}});JW.Plugins.Router.Redirector=function(){JW.Plugins.Router.Redirector._super.call(this);this.args=JW.args(arguments);if(this.args[3]==null){this.args[3]=true}this.own(new JW.Timeout(this.redirect,this))};JW.extend(JW.Plugins.Router.Redirector,JW.UI.Component,{redirect:function(){JW.Plugins.Router.redirect.apply(JW.Plugins.Router,this.args)}});